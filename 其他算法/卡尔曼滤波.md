# 卡尔曼滤波
注: 这里的卡尔曼滤波的推导过程参考张虎著机器人slam导航核心技术与实战，整体形式为线性化之后的形式。和网络上的最终形式略有不同，但是过程基本一致。
## 系统的状态方程和观测方程的建立
首先要建立系统的状态转移方程和观测方程：
$$x_k = g(x_{k-1}, u_k) + \epsilon_k$$
$$z_k = h(x_k) + \delta_k$$
这里直接进行线性化以简化问题，方便后面的推导:
$$x_k = A_k x_{k-1} + B_k u_k + \epsilon_k$$
$$z_k = C_k x_k + \delta_k$$
其中$x$ $u$ $z$都是向量，$A$ $B$ $C$都是矩阵。
**对噪声进行定义，此处可以跳过不看，因为推导估计写不完，看了也没用**
这里需要对噪声$\epsilon_k$和$\delta_k$进行定义。整体定义为**与时间无关的相互独立的零均值高斯噪声**。
这句话包含了三个条件：
1. 与时间无关：
   $$E[\epsilon_i \epsilon_j^T] = 0$$
   $$E[\delta_i \delta_j^T] = 0$$ 其中i j 为不同时间的噪声。
   不同时间之间的噪声是无干扰的，期望为0。

2. 相互独立：
   $$E[\epsilon_i \delta_j^T] = 0$$
3. 零均值高斯噪声：
   $$E[\epsilon] = 0$$
   $$E[\delta] = 0$$
则噪声的协方差可以表示为：
$$E[\epsilon_i \epsilon_j^T] = Q_k$$
$$E[\delta_i \delta_j^T] = R_k$$ 
**这个结论在后面的数学推导中比较重要，但是今晚应该是写不到了**

## 状态估计的两个步骤
在上一步建立的状态转移方程和观测方程的基础上，我们对于当前的状态估计可以从两个方面进行。
1. (预测)根据状态转移方程，计算出现在的状态。极限情况就是这个系统的控制是无噪声的，那么完全只用这个就能进行当前系统的状态估计。
2. (校正/更新)根据我们观测的结果，根据观测方程，计算出当前状态。

卡尔曼滤波就是结合这两个方面，得出一个最优的估计的方法。
### 预测步骤
根据我们k时刻的输入$u_k$，我们可以**预测出**一个当前的状态估计值：**$\hat{x}^{'}_k$**。
注意在本文中，$\hat{}$表示估计值，$'$表示预测值。这个过程可以表示为：
$$\hat{x}^{'}_k = A_k \hat{x}^{'}_{k-1} + B_k u_k$$
根据这个转移方程，就可以知道当前一个估计的预测状态。根据这个估计的预测状态，我们有可以估计出这个状态的观测值：
$$\hat{z}^{'}_k = C_k \hat{x}^{'}_k$$

## 校正步骤
我们当然可以获得当前的实际的观测值$z_k$, 那么我们就可以构造出一个估计的观测值和实际的观测值之间的差值：
$$\widetilde{z}_k = z_k - \hat{z}^{'}_k$$
这个$\widetilde{z}_k$就是校正的输入值。

## 加权平均
假设我们的估计值为$\hat{x}_k$, 那么设置一个权重$K_k$, 也就是卡尔曼增益，那么我们可以得到：
$$\hat{x}_k = \hat{x}^{'}_k + K_k \widetilde{z}_k$$
因为这里$\widetilde{z}_k$是残差的形式，将$\widetilde{z}_k = z_k - \hat{z}^{'}_k$带入得：
$$\hat{x}_k = \hat{x}^{'}_k + K_k (z_k - C_k \hat{x}^{'}_k)$$
根据上式，如果$k_k$接近1,那么整体估计更接近观测值，如果$k_k$接近0，那么整体估计更接近预测值。

## 卡尔曼的惊险一跃or状态估计都爱玩的一手小套路
上面我们已经知道了$k_k$就是决定当前状态估计的精度。那么怎么才能得到最高的精度呢？这里基本上所有的状态估计算法-卡尔曼/优化/map.....都最终采用的一个套路，那就是误差为0的时候精度最高。
误差为零精度最高，换个面孔就是在优化方法中损失最小/代价最小。那么我们就要构建这个误差：
上面我们已经知道我们估计的k时刻状态为$\hat{x}_k$，那么误差就是：
$$e_k = x_k - \hat{x}_k$$
我们只要让$e_k$最小就行，在实际中，一般会用均方差，也就是距离的平方和的均值计算,就是：
$$P_k = E[e_k, e_k^T] = 0$$
这里在数学推导过程中就会涉及到两个协方差，即一个是预测阶段的状态转移方程的噪声协方差，一个是最终校正阶段整体误差的协方差。中间又涉及两个变量，即一个是我们预测的状态$\hat{x}^{'}_k$, 一个是我们最终估计得到的状态$\hat{x}_k$。还要计算一个卡尔曼增益$k_k$。这就是卡尔曼滤波的两个步骤，五个求解量。中间的数学推导后续在做。
对于一个状态估计问题，各种算法到最后都不外乎构建残差，也就是$e_k = x_k - \hat{x}_k$，核心思想都不变，无非是卡尔曼的递推回去求协方差，还是MAP方法用整个时间最小化残差，还是ICP匹配这种的求最小化残差。只要抓住残差构建这个核心，向前捋他的残差是怎么构建的，向后捋他是怎么将残差问题转化到一个求最值问题的，剩下的也就好理解了。

